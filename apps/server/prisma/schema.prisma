generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  nickname     String
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ratings Rating[]
  matches Match[] @relation("MatchCreator")
}

model Rating {
  id          String   @id @default(cuid())
  userId      String
  modeKey     String
  gamesPlayed Int      @default(0)
  wins        Int      @default(0)
  losses      Int      @default(0)
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, modeKey])
  @@index([modeKey, wins])
}

model Match {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())

  // Who initiated the match (optional; can be null for pure anon matchmaking)
  createdByUserId String?
  createdByUser   User?    @relation("MatchCreator", fields: [createdByUserId], references: [id])

  modeKey        String
  grade          Int
  subject        String
  semester       String
  totalQuestions Int

  seed      Int?
  reason    String
  winnerUserId String?

  // Snapshot of participants/results (array of objects)
  players Json

  @@index([createdAt])
  @@index([modeKey, createdAt])
  @@index([winnerUserId])
}
